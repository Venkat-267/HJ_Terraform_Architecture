pipeline {
    agent any

    environment {
        // Use IAM roles for AWS access if running on AWS
        AWS_ACCESS_KEY_ID = credentials('aws-credentials-id') 
        AWS_SECRET_ACCESS_KEY = credentials('aws-credentials-id')
        TF_VAR_SECRET_PEM = credentials('demo-pem-as') // PEM file stored as secret
    }

    stages {
        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }

        stage('Terraform Plan') {
            steps {
                sh 'terraform plan -out=tfplan'
            }
        }

        stage('Terraform Apply') {
            steps {
                sh 'terraform apply -auto-approve tfplan'
            }
        }

        stage('Get EC2 IPs') {
            steps {
                script {
                    def outputEc2PublicIp = sh(script: 'terraform output -json ec2_instance_public_ip', returnStdout: true).trim()
                    def jsonSlurper = new groovy.json.JsonSlurper()
                    def ec2Ips = jsonSlurper.parseText(outputEc2PublicIp)
                    env.EC2_PUBLIC_IPS = ec2Ips.collect { it }.join(',')
                }
            }
        }

        stage('Knife Bootstrap') {
            steps {
                script {
                    // Convert the serialized EC2 IPs back to a list
                    def ec2Ips = env.EC2_PUBLIC_IPS.split(',')

                    // Iterate over the list of IPs and bootstrap each EC2 instance
                    for (int i = 0; i < ec2Ips.size(); i++) {
                        def publicIp = ec2Ips[i]
                        echo "Bootstrapping ${publicIp}"

                        withCredentials([file(credentialsId: 'admin134', variable: 'VALIDATION_KEY'), 
                                        file(credentialsId: 'demo-pem-as', variable: 'SSH_PEM')]) {
                            sh """
                                ssh -o StrictHostKeyChecking=no -i ${SSH_PEM} ubuntu@3.7.55.183 exit
                                knife bootstrap 3.7.55.183 --connection-user ubuntu --sudo --ssh-identity-file ${SSH_PEM} \
                                --node-name nodejs-app-server-0 --run-list recipe[node-js] --yes --chef-license accept \
                                --server-url https://ec2-13-234-77-4.ap-south-1.compute.amazonaws.com/organizations/orgs \
                                --ssh-user ubuntu --bootstrap-version 17.9.0 \
                                --validation-key ${VALIDATION_KEY} 
                            """
                        }

                    }
                }
            }
        }


    }

    post {
        success {
            echo 'Terraform deployment and Chef bootstrapping successful!'
        }
        failure {
            echo 'Deployment or bootstrapping failed.'
        }
    }
}
