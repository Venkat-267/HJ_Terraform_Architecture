pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-credentials-id') // Jenkins credential ID
        AWS_SECRET_ACCESS_KEY = credentials('aws-credentials-id') // Jenkins credential ID
        TF_VAR_SECRET_PEM = credentials('demo-pem-as')
    }

    stages {
        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }

        stage('Terraform Plan') {
            steps {
                sh 'terraform plan -out=tfplan'
            }
        }

        stage('Terraform Apply') {
            steps {
                sh 'terraform apply -auto-approve tfplan'
            }
        }

        stage('Get EC2 IPs') {
            steps {
                script {
                    // Capture the public IP addresses from Terraform output
                    def outputEc2PublicIp = sh(script: 'terraform output -json ec2_instance_public_ip', returnStdout: true).trim()

                    def ec2Ips = []
                    def jsonSlurper = new groovy.json.JsonSlurper()
                    ec2Ips = jsonSlurper.parseText(outputEc2PublicIp)
                    env.EC2_PUBLIC_IPS = ec2Ips
                }
            }
        }

        script {
                    // Iterate over the list of IPs and bootstrap each EC2 instance
                    for (int i = 0; i < env.EC2_PUBLIC_IPS.size(); i++) {
                        def publicIp = env.EC2_PUBLIC_IPS[i]
                        echo "Bootstrapping ${publicIp}"

                        // Securely pass the PEM file via environment variable instead of string interpolation
                        withCredentials([file(credentialsId: 'demo-pem-as', variable: 'PEM_FILE')]) {
                            sh """
                            knife bootstrap ${publicIp} \
                            --ssh-user ubuntu \
                            --identity-file ${PEM_FILE} \
                            --node-name node-${i} \
                            --sudo \
                            --yes \
                            --run-list 'recipe[node-js]'
                            """
                        }
                    }
                }
    }

    post {
        success {
            echo 'Terraform deployment successful!'
        }
        failure {
            echo 'Terraform deployment failed.'
        }
    }
}
